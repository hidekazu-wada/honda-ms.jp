/**
 * åˆå›è¨ªå•æ™‚ã«è¡¨ç¤ºã™ã‚‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚
 * ãƒ•ã‚©ãƒ³ãƒˆèª­è¾¼çŠ¶æ³ã‚„æœ€ä½è¡¨ç¤ºæ™‚é–“ã‚’è€ƒæ…®ã—ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã€‚
 */

/**
 * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢åˆ¶å¾¡
 */
class SimpleLoadingController {
  constructor() {
    this.loadingElement = document.querySelector('#loading-screen');
    this.isFirstVisit = document.body.classList.contains('first-visit');
    this.fadeOutDuration = 0.8; // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆç§’ï¼‰
    this.minLoadingTime = 3000; // æœ€ä½è¡¨ç¤ºæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    this.debugMode = true;
    this.textPrepared = false; // ãƒ†ã‚­ã‚¹ãƒˆæº–å‚™å®Œäº†ãƒ•ãƒ©ã‚°
    this.fontLoaded = false; // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°
    this.loadingStartTime = Date.now(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹æ™‚åˆ»

    if (this.debugMode) {
      console.log('ğŸ¬ Loading controller created:', {
        hasLoadingElement: !!this.loadingElement,
        isFirstVisit: this.isFirstVisit,
        bodyClasses: document.body.className,
        loadingStartTime: this.loadingStartTime,
      });
    }

    // åˆæœŸåŒ–å¾Œã«ãƒ†ã‚­ã‚¹ãƒˆæº–å‚™ã‚’å®Ÿè¡Œ
    this.prepareTextIfNeeded();
  }

  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã«å®Ÿè¡Œï¼‰
   */
  prepareTextIfNeeded() {
    // ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™ã¯åˆå›ãƒ»ãƒªãƒ”ãƒ¼ãƒˆå•ã‚ãšå®Ÿè¡Œ
    if (
      window.TextAnimation &&
      typeof window.TextAnimation.prepareTextAnimation === 'function'
    ) {
      if (this.debugMode) {
        console.log('ğŸ“ Preparing text animation during loading');
      }

      window.TextAnimation.prepareTextAnimation();
      this.textPrepared = true;
    } else {
      // TextAnimationãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
      setTimeout(() => {
        this.prepareTextIfNeeded();
      }, 100);
    }
  }

  /**
   * ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†ï¼ˆå¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
   */
  handleFontLoaded() {
    this.fontLoaded = true;

    if (this.debugMode) {
      const elapsedTime = Date.now() - this.loadingStartTime;
      console.log('ğŸ”¤ handleFontLoaded called:', {
        isFirstVisit: this.isFirstVisit,
        hasLoadingElement: !!this.loadingElement,
        textPrepared: this.textPrepared,
        elapsedTime: elapsedTime + 'ms',
      });
    }

    if (!this.isFirstVisit || !this.loadingElement) {
      // åˆå›è¨ªå•ã§ãªã„ã€ã¾ãŸã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ãŒãªã„å ´åˆ
      if (this.debugMode) {
        console.log(
          'ğŸ”„ Not first visit or no loading element - starting text animation directly'
        );
      }
      this.startTextAnimation();
      return;
    }

    // åˆå›è¨ªå•æ™‚ï¼šæœ€ä½è¡¨ç¤ºæ™‚é–“ã‚’ãƒã‚§ãƒƒã‚¯
    this.checkMinimumLoadingTime();
  }

  /**
   * æœ€ä½è¡¨ç¤ºæ™‚é–“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’åˆ¶å¾¡
   */
  checkMinimumLoadingTime() {
    const elapsedTime = Date.now() - this.loadingStartTime;
    const remainingTime = this.minLoadingTime - elapsedTime;

    if (this.debugMode) {
      console.log('â±ï¸ Checking minimum loading time:', {
        elapsedTime: elapsedTime + 'ms',
        remainingTime: remainingTime + 'ms',
        fontLoaded: this.fontLoaded,
      });
    }

    if (remainingTime <= 0) {
      // æœ€ä½è¡¨ç¤ºæ™‚é–“ã¯æ—¢ã«çµŒéæ¸ˆã¿
      if (this.debugMode) {
        console.log('âœ… Minimum time already elapsed - hiding loading screen');
      }
      this.hideLoadingScreen();
    } else {
      // æœ€ä½è¡¨ç¤ºæ™‚é–“ã¾ã§å¾…æ©Ÿ
      if (this.debugMode) {
        console.log(
          `â³ Waiting additional ${remainingTime}ms for minimum loading time`
        );
      }

      setTimeout(() => {
        if (this.debugMode) {
          console.log(
            'âœ… Minimum loading time reached - hiding loading screen'
          );
        }
        this.hideLoadingScreen();
      }, remainingTime);
    }
  }

  /**
   * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
   */
  hideLoadingScreen() {
    if (this.debugMode) {
      console.log('ğŸŒ… Starting loading screen fade out');
    }

    // GSAPãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof gsap === 'undefined') {
      console.error('GSAP not available - using fallback');
      this.loadingElement.style.display = 'none';
      this.startTextAnimation();
      return;
    }

    // GSAPã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    gsap.to(this.loadingElement, {
      opacity: 0,
      duration: this.fadeOutDuration,
      ease: 'power2.out',
      onComplete: () => {
        // å®Œå…¨ã«éè¡¨ç¤º
        this.loadingElement.style.display = 'none';

        if (this.debugMode) {
          console.log('âœ¨ Loading screen hidden - starting text animation');
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        this.startTextAnimation();
      },
    });
  }

  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
   */
  startTextAnimation() {
    if (this.debugMode) {
      console.log(
        'ğŸ“ startTextAnimation called - textPrepared:',
        this.textPrepared
      );
    }

    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã‚‹
    setTimeout(() => {
      if (
        window.TextAnimation &&
        typeof window.TextAnimation.startGsapAnimation === 'function'
      ) {
        if (this.debugMode) {
          console.log('ğŸ“ Starting text animation');
        }

        window.TextAnimation.startGsapAnimation();
      } else {
        console.warn('TextAnimation not available:', window.TextAnimation);
      }
    }, 300);
  }
}

/**
 * ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 */
let loadingController = null;

/**
 * åˆæœŸåŒ–
 */
document.addEventListener('DOMContentLoaded', () => {
  loadingController = new SimpleLoadingController();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«APIã¨ã—ã¦å…¬é–‹
  window.LoadingScreenController = {
    handleFontLoaded: () => {
      console.log('ğŸ”— Global handleFontLoaded called');
      if (loadingController) {
        loadingController.handleFontLoaded();
      } else {
        console.warn('ğŸ”— loadingController instance not found');
      }
    },
  };

  console.log('ğŸ¬ Simple Loading Controller initialized');
});